<!-- 82098653-c349-45ed-a5d6-2d8bbb95db62 3aa4abae-8d37-4e4d-b921-1231608cef71 -->
# Kế hoạch: Xuất toàn bộ HTML từ DynamicZone

### Mục tiêu

- Xuất HTML của mọi nội dung nằm trong `DynamicZone` sau khi render (nhiều instance), dùng cho export tĩnh.
- Không phụ thuộc Angular Elements; ưu tiên lấy từ `ViewContainerRef` (container).

### Phạm vi thay đổi

- `projects/builder/src/lib/core/core.base.ts`: Bổ sung API quản lý vùng render và export HTML, tuỳ chọn chế độ append/replace.
- `projects/builder/src/lib/widgets/dynamic-zone/dynamic-zone.ts`: Gọi API của `CoreBase` đúng chỗ, thêm hàm `exportHtml()` trả về toàn bộ HTML vùng dynamic.
- (Không bắt buộc) `projects/builder/src/lib/widgets/dynamic-zone/dynamic-zone.html`: Giữ nguyên (dùng `#container` hiện có). Chỉ thêm `#host` nếu sau này cần Angular Elements.

### Thay đổi chi tiết

#### 1) Cập nhật CoreBase để quản lý container và export

- Thêm setter để gán `ViewContainerRef` một cách rõ ràng (không dựa vào field tạm `vcrRef`).
- Thêm `createWidget(component, options?: { append?: boolean })`:
  - append=false: `clear()` rồi tạo 1 instance (hiện hành)
  - append=true: tạo thêm instance, không `clear()`
- Thêm `exportHtmlFrom(containerEl: HTMLElement): string` để trích HTML.

Gợi ý snippet (rút gọn, chỉ phần mới/đáng chú ý):

```ts
// core.base.ts (bổ sung)
public setContainerRef(vcr: ViewContainerRef | null): void { this.vcrRef = vcr; }
public createWidget(cmp: Type<unknown>, options?: { append?: boolean }): void {
  const vcr = this.vcr();
  if (!vcr) return;
  if (!options?.append) vcr.clear();
  vcr.createComponent(cmp as Type<unknown>);
}
public exportHtmlFrom(containerEl: HTMLElement): string {
  return containerEl.innerHTML;
}
```

#### 2) DynamicZone: dùng CoreBase + thêm exportHtml()

- Khi `add(key)`:
  - `this.setContainerRef(this.container)`
  - gọi `this.createWidget(cmp, { append: true | false })` tuỳ nhu cầu (mặc định bạn có thể giữ replace; có thể nhận `options` nếu cần)
- Thêm `exportHtml(): string` để trả về `innerHTML` của vùng `container`.

Gợi ý snippet (rút gọn):

```ts
// dynamic-zone.ts (bổ sung)
add(key: string, options?: { append?: boolean }): void {
  const cmp = this.registry[key];
  if (!cmp) return;
  this.setContainerRef(this.container);
  this.createWidget(cmp, { append: options?.append });
}
exportHtml(): string {
  const el = (this.container.element.nativeElement as HTMLElement);
  return this.exportHtmlFrom(el);
}
```

#### 3) App: sử dụng export

- Ví dụ nút Export gọi `dz.exportHtml()` và tải xuống file `.html`.

Gợi ý snippet ngắn:

```ts
const html = this.dz.exportHtml();
const blob = new Blob([html], { type: 'text/html' });
// ... download
```

### Rủi ro / Lưu ý

- HTML xuất ra là phần trong `DynamicZone`; nơi nhúng cần CSS (Tailwind) tương ứng.
- Nếu sau này dùng Angular Elements và cần export phần tử custom element, cân nhắc thêm `#host` và method tương tự `exportHtmlFromHost()`.
- Quản lý lifecycle: khi append nhiều instance, cung cấp thêm API `clear()` nếu cần.

### To-dos

- [ ] Thêm setContainerRef, createWidget, exportHtmlFrom vào core.base.ts
- [ ] Cập nhật add() dùng CoreBase mới, thêm exportHtml()
- [ ] Thêm ví dụ gọi exportHtml() và tải file trong app (tuỳ chọn)