<div class="app-container" (click)="onContainerClick($event)">
  <builder-navigation
    (toggleLeftSidebar)="onToggleLeftSidebar()"
    (toggleRightSidebar)="onToggleRightSidebar()"
    (toggleDragMode)="onToggleDragMode()"
    (toggleFullscreen)="onToggleFullscreen()"
    (toggleNavigator)="onToggleNavigator()"
    (download)="onDownload()"
    (deviceChange)="onDeviceChange($event)"
  ></builder-navigation>

  <!-- Main Layout -->
  <div class="builder-layout" #layoutRoot>
    <!-- Left Sidebar: Toolbox -->
    <div
      class="sidebar-left"
      [style.flex-basis.%]="leftWidth()"
      [style.max-width.%]="leftWidth()"
      [style.display]="isLeftSidebarHidden() ? 'none' : 'flex'"
    >
      <div class="panel-header">Components</div>
      <div class="panel-content">
        <app-tool-box (addWidget)="dz.add($event, { append: true })"></app-tool-box>
      </div>
    </div>

    <!-- Left Resizer -->
    <div class="resizer-vertical-left" (mousedown)="startDragLeft($event)"></div>
    @if(isDraggingLeft()) {
    <div class="resizer-ghost-left" [style.left.px]="ghostLeftPosition()"></div>
    }

    <!-- Center: Canvas -->
    <div
      class="canvas-area"
      [style.flex-basis.%]="centerWidth()"
      [style.max-width.%]="centerWidth()"
    >
      <div class="panel-header">Canvas</div>
      <div
        class="canvas-content"
        [class.device-mobile]="activeDevice() === 'mobile'"
        [class.device-tablet]="activeDevice() === 'tablet'"
        [class.device-desktop]="activeDevice() === 'desktop'"
        [class.is-panning]="isPanning()"
        [style.transform]="'translate(' + panX() + 'px, ' + panY() + 'px) scale(' + zoomLevel() / 100 + ')'"
        [style.transform-origin]="'0 0'"
        [style.width.px]="activeDevice() === 'desktop' ? null : getViewportWidth()"
        [style.max-width.px]="activeDevice() === 'desktop' ? null : getViewportWidth()"
        [style.min-height.px]="activeDevice() === 'desktop' ? null : getViewportHeight()"
        (wheel)="onCanvasWheel($event)"
        (mousedown)="onCanvasMouseDown($event)"
        (contextmenu)="$event.preventDefault()"
      >
        <app-dynamic-zone
          #dz
          [registry]="registry"
          [componentDefinitions]="componentDefinitions"
          [draggingDisabled]="isDragDisabled()"
        ></app-dynamic-zone>
      </div>
    </div>
  </div>
</div>

<router-outlet />
<builder-modal-host />
<builder-drop-indicator />

<!-- Floating Navigator Panel -->
@if (showNavigatorFloating()) {
<app-floating-panel
  title="Navigator"
  [initialX]="initialNavigatorX()"
  [initialY]="initialNavigatorY()"
  [onClose]="closeNavigatorFloating"
>
  <app-navigator-panel
    [rootComponent]="getRootComponent()"
    (componentSelect)="onNavigatorSelect($event)"
  ></app-navigator-panel>
</app-floating-panel>
}

<!-- Download Modal -->
@if (showDownloadModal()) {
  <app-download-modal (close)="showDownloadModal.set(false)"></app-download-modal>
}
